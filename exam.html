<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC Exam Quiz v2 - Multilingual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f5; overflow-x: hidden; }
        .screen { display: none; }
        .screen.active { display: block; }
        .tab-btn.active { border-bottom-color: #4f46e5; color: #4f46e5; }
        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 5px; height: 250px; perspective: 500px; }
        .podium-item { width: 30%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding: 1rem; border-radius: 12px 12px 0 0; color: #374151; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border-bottom: 5px solid rgba(0,0,0,0.2); transform: translateY(250px); opacity: 0; }
        @keyframes slideUp { from { transform: translateY(250px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .podium-item.animate { animation: slideUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .podium-1 { height: 100%; background: linear-gradient(to top, #ffd700, #fde68a); animation-delay: 1.2s !important; }
        .podium-2 { height: 80%; background: linear-gradient(to top, #c0c0c0, #e5e7eb); animation-delay: 0.6s !important; }
        .podium-3 { height: 60%; background: linear-gradient(to top, #cd7f32, #f9c288); animation-delay: 0s !important; }
        .podium-rank { font-size: 2.5rem; font-weight: 700; line-height: 1; }
        .podium-name { font-size: 1.25rem; font-weight: 600; margin-top: 0.5rem; text-shadow: 0px 1px 2px rgba(255,255,255,0.5); }
        .podium-score { font-size: 1rem; margin-top: 0.25rem; }
        .fa-crown { color: #f59e0b; font-size: 2rem; margin-bottom: 0.5rem; }
        .lang-btn.selected { border-color: #4f46e5; transform: scale(1.1); box-shadow: 0 0 15px rgba(79, 70, 229, 0.5); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="app-container" class="max-w-4xl mx-auto p-4 min-h-screen flex flex-col justify-center">
        <!-- Home Screen -->
        <div id="home-screen" class="screen active text-center">
            <div class="bg-white p-8 rounded-2xl shadow-xl">
                <img src="TRC-Logo.jpg" alt="Thai Rayon Logo" class="mx-auto h-24 w-24 mb-4 object-contain">
                <h1 class="text-4xl font-bold mb-2">TRC Exam Mode</h1>
                <p class="text-gray-600 mb-8">Organizational Learning Platform through Gamification</p>
                <div class="flex flex-col md:flex-row gap-4 justify-center">
                    <button id="show-host-options-btn" class="bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:from-red-600 hover:to-orange-600 transition duration-300 shadow-md"><i class="fas fa-plus-circle mr-2"></i>Create / Choose An Exam (Host)</button>
                    <button id="show-player-join-btn" class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-bold py-3 px-6 rounded-lg hover:from-teal-600 hover:to-cyan-600 transition duration-300 shadow-md"><i class="fas fa-pencil-alt mr-2"></i>Do An Exam (Player)</button>
                </div>
                <div class="mt-8 text-center">
                    <a href="index.html" class="text-gray-500 hover:text-orange-600 transition-colors font-semibold"><i class="fas fa-arrow-left mr-2"></i>Back to Lobby</a>
                </div>
                <div class="mt-6 text-xs text-gray-400">
                    <p>User: <span id="user-id-display">Loading...</span></p>
                </div>
                <div class="mt-10 text-xs text-gray-500">
                    <p>&copy; 2025 Sittidate Purintawarrakun</p>
                </div>
            </div>
        </div>
        
        <!-- Host Options Screen -->
        <div id="host-options-screen" class="screen"><div class="bg-white p-8 rounded-2xl shadow-xl text-center"><h2 class="text-3xl font-bold mb-6">Manage An Exam</h2><div class="flex flex-col md:flex-row gap-4 justify-center"><button id="create-quiz-btn" class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-indigo-600 transition shadow-md">Create A New Exam</button><button id="view-my-quizzes-btn" class="bg-gradient-to-r from-purple-500 to-violet-500 text-white font-bold py-3 px-6 rounded-lg hover:from-purple-600 hover:to-violet-600 transition shadow-md">Pick an available Exam Set</button></div><button class="back-btn mt-6 text-gray-500 hover:text-gray-700">&larr; Back</button></div></div>
        
        <!-- ✨ MODIFIED: Quiz Creator Screen (Bilingual) -->
        <div id="quiz-creator-screen" class="screen">
            <div class="bg-white p-8 rounded-2xl shadow-xl">
                <h2 class="text-3xl font-bold mb-6">Create / Edit Exam</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 border-b pb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Exam Title (TH)</label>
                        <input type="text" id="quiz-title-th" placeholder="ชื่อชุดข้อสอบ" class="w-full p-3 border rounded-lg mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Exam Title (EN)</label>
                        <input type="text" id="quiz-title-en" placeholder="Exam Title" class="w-full p-3 border rounded-lg mt-1">
                    </div>
                    <div class="md:col-span-2">
                         <label class="block text-sm font-medium text-gray-700">Description (TH)</label>
                        <textarea id="quiz-description-th" placeholder="คำอธิบายสั้นๆ (ถ้ามี)" class="w-full p-3 border rounded-lg mt-1" rows="2"></textarea>
                    </div>
                     <div class="md:col-span-2">
                         <label class="block text-sm font-medium text-gray-700">Description (EN)</label>
                        <textarea id="quiz-description-en" placeholder="Short Description (if any)" class="w-full p-3 border rounded-lg mt-1" rows="2"></textarea>
                    </div>
                </div>
                <div id="questions-container"></div>
                <button id="add-question-btn" class="mt-4 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition w-full"><i class="fas fa-plus mr-2"></i>Add Question</button>
                <div class="mt-6 flex gap-4">
                    <button id="save-quiz-btn" class="flex-1 bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition disabled:bg-gray-400">Save</button>
                    <button class="back-btn flex-1 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                </div>
            </div>
        </div>

        <!-- My Quizzes Screen -->
        <div id="my-quizzes-screen" class="screen">
            <div class="bg-white p-8 rounded-2xl shadow-xl">
                <h2 class="text-3xl font-bold mb-4">Select Exam List</h2>
                <div class="mb-6 relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                    <input type="text" id="search-quiz-input" placeholder="ค้นหาจากชื่อข้อสอบ..." class="w-full p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-indigo-500" />
                </div>
                <div id="my-quizzes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <button class="back-btn mt-8 text-gray-500 hover:text-gray-700">&larr; Back</button>
            </div>
        </div>
        
        <!-- ✨ MODIFIED: Player Join Screen (Language Selection) -->
        <div id="player-join-screen" class="screen">
            <div class="bg-white p-8 rounded-2xl shadow-xl text-center">
                <h2 class="text-3xl font-bold mb-4">Join the Exam</h2>
                <p class="text-gray-600 mb-4">Please select your language</p>
                <div class="mb-6 flex justify-center gap-4">
                    <button id="lang-th-btn" class="lang-btn p-2 rounded-lg border-2 border-transparent transition-all duration-300">
                        <img src="https://flagcdn.com/th.svg" width="60" alt="ภาษาไทย">
                    </button>
                    <button id="lang-en-btn" class="lang-btn p-2 rounded-lg border-2 border-transparent transition-all duration-300">
                        <img src="https://flagcdn.com/gb.svg" width="60" alt="English">
                    </button>
                </div>
                <input type="text" id="game-pin-input" placeholder="Join Code (4 digits)" maxlength="4" class="w-full text-center text-2xl p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-green-500 tracking-widest">
                <input type="text" id="player-name-input" placeholder="Your Name" class="w-full text-center p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-green-500">
                <button id="join-game-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition disabled:bg-gray-400">Join</button>
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-700">&larr; Back</button>
            </div>
        </div>

        <!-- ✨ MODIFIED: Host Lobby Screen (Session Name) -->
        <div id="host-lobby-screen" class="screen">
            <div class="bg-white p-8 rounded-2xl shadow-xl text-center">
                <p class="text-gray-600">Players, enter this code to join:</p>
                <div class="my-4 bg-indigo-600 text-white p-4 rounded-lg">
                    <p class="text-lg">Join Code</p>
                    <p id="game-pin-display" class="text-6xl font-bold tracking-widest">----</p>
                </div>
                <input type="text" id="session-name-input" placeholder="Enter Session Name (optional)" class="w-full text-center p-2 border rounded-lg mt-4 focus:ring-2 focus:ring-indigo-500">
                <h3 class="text-2xl font-bold mt-6 mb-4">Participants (<span id="player-count">0</span>)</h3>
                <div id="player-list" class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center min-h-[50px]"></div>
                <button id="start-game-btn" class="mt-8 w-full bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 transition text-2xl shadow-lg disabled:bg-gray-400" disabled>Start!</button> 
                <button class="back-btn mt-6 text-gray-500 hover:text-gray-700"> &larr; Back to Home</button>
            </div>
        </div>

        <!-- Other Screens (Unchanged HTML structure) -->
        <div id="host-in-progress-screen" class="screen"><div class="bg-white p-8 rounded-2xl shadow-xl text-center"><h2 class="text-3xl font-bold mb-2">Game in Progress...</h2><p class="text-gray-600 mb-6">Join Code: <span id="in-progress-pin" class="font-bold text-indigo-600"></span></p><h3 class="text-2xl font-bold mt-6 mb-4">Player Status</h3><p class="mb-4"><span id="completed-players-count">0</span> / <span id="total-players-count">0</span> Player Finished the Exam</p><div id="in-progress-player-list" class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center min-h-[50px]"></div><button id="end-game-btn" class="mt-8 w-full bg-emerald-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-600 transition text-2xl shadow-lg disabled:bg-gray-400" disabled><i class="fas fa-flag-checkered mr-2"></i>End Game and View Summary</button></div></div>
        <div id="results-screen" class="screen"><div class="bg-white p-8 rounded-2xl shadow-xl"><h2 class="text-3xl font-bold mb-2 text-center"> 🏆  Score Summary  🏆 </h2><div id="final-podium" class="podium-container mt-6"></div><div id="leaderboard-list" class="space-y-2 mt-6"></div><button id="back-to-home-from-results-btn" class="mt-8 w-full bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-600 transition">Back to Home</button></div></div>
        <div id="player-lobby-screen" class="screen"><div class="bg-white p-8 rounded-2xl shadow-xl text-center"><i class="fas fa-spinner fa-spin text-5xl text-teal-500 mb-4"></i><h2 class="text-3xl font-bold">Participation confirmed!</h2><p class="text-gray-600 mt-2">Waiting for the host to start...</p></div></div>
        <div id="player-answer-screen" class="screen"><div class="bg-white p-6 rounded-2xl shadow-xl"><p id="exam-progress" class="text-right text-sm text-gray-500 mb-2"></p><div class="bg-gray-50 p-4 rounded-lg mb-6 min-h-[100px] flex items-center justify-center"><p id="player-q-text" class="text-xl md:text-2xl font-semibold text-gray-800 text-center"></p></div><div id="exam-options-container" class="space-y-3 mb-6"></div><button id="exam-submit-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition shadow-md">Submit Answer</button></div></div>
        <div id="player-finished-screen" class="screen"><div class="bg-white p-8 rounded-2xl shadow-xl text-center"><i class="fas fa-check-circle text-5xl text-emerald-500 mb-4"></i><div id="finished-message"><h2 class="text-3xl font-bold">Finished the Exam!</h2><p class="text-gray-600 mt-2">Waiting for the host to end the exam to view the summary...</p></div></div></div>
        <div id="history-screen" class="screen"><div class="bg-white p-8 rounded-2xl shadow-xl"><h2 class="text-3xl font-bold mb-1">Play History</h2><p class="text-gray-500 mb-6">For: <span id="history-quiz-title" class="font-semibold"></span></p><div id="history-list" class="space-y-3"></div><button class="back-to-quizzes-btn mt-6 text-gray-500 hover:text-gray-700">&larr; Return to Exam List</button></div></div>
        <div id="report-screen" class="screen"><div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl"><div class="flex justify-between items-start mb-4"><div><h2 id="report-quiz-title" class="text-2xl md:text-3xl font-bold"></h2><p id="report-session-name" class="text-gray-500"></p></div><div class="flex flex-col items-end gap-2"><button id="share-report-btn" class="bg-blue-500 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-blue-600 transition-colors"><i class="fas fa-envelope mr-1"></i> Share</button></div></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="bg-amber-50 border border-amber-200 text-amber-900 p-4 rounded-xl flex items-center gap-4"><i class="fas fa-bullseye text-2xl text-amber-500"></i><div><p class="font-semibold text-sm">Accuracy</p><p id="report-summary-accuracy" class="text-2xl font-bold">-%</p></div></div><div class="bg-blue-50 border border-blue-200 text-blue-900 p-4 rounded-xl flex items-center gap-4"><i class="fas fa-tasks text-2xl text-blue-500"></i><div><p class="font-semibold text-sm">Completion</p><p id="report-summary-completion" class="text-2xl font-bold">-%</p></div></div><div class="bg-violet-50 border border-violet-200 text-violet-900 p-4 rounded-xl flex items-center gap-4"><i class="fas fa-users text-2xl text-violet-500"></i><div><p class="font-semibold text-sm">Participants</p><p id="report-summary-participants" class="text-2xl font-bold">-</p></div></div><div class="bg-teal-50 border border-teal-200 text-teal-900 p-4 rounded-xl flex items-center gap-4"><i class="fas fa-question-circle text-2xl text-teal-500"></i><div><p class="font-semibold text-sm">Questions</p><p id="report-summary-questions" class="text-2xl font-bold">-</p></div></div></div><div class="border-b border-gray-200 mb-4"><nav class="flex space-x-4" aria-label="Tabs"><button id="tab-btn-participants" class="tab-btn active font-medium px-1 py-2 border-b-2 border-transparent">Participants</button><button id="tab-btn-questions" class="tab-btn font-medium px-1 py-2 border-b-2 border-transparent">Questions</button></nav></div><div id="tab-content-participants" class="tab-content"></div><div id="tab-content-questions" class="tab-content hidden"></div><button class="back-to-history-btn mt-6 text-gray-500 hover:text-gray-700">&larr; Go to History Page</button></div></div>
        <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"><div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm"><p id="alert-message" class="mb-4"></p><button id="alert-ok-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg">ตกลง</button></div></div>
    </div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, where, getDocs, onSnapshot, serverTimestamp, deleteDoc, orderBy, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const firebaseConfig = { apiKey: "AIzaSyCu9xCpoV_Ei0izGWuch9bPNOLU8nu7vBg", authDomain: "trc-funny-quiz.firebaseapp.com", projectId: "trc-funny-quiz", storageBucket: "trc-funny-quiz.appspot.com", messagingSenderId: "323647073409", appId: "1:323647073409:web:1445589b1bc6eb77bcf180" };
    
    const CONSTANTS = {
        APP_ID: 'trc-exam-quiz', // Keep ID same for DB compatibility
        SCREENS: {
            HOME: 'home-screen', HOST_OPTIONS: 'host-options-screen', QUIZ_CREATOR: 'quiz-creator-screen',
            MY_QUIZZES: 'my-quizzes-screen', PLAYER_JOIN: 'player-join-screen', HOST_LOBBY: 'host-lobby-screen',
            HOST_IN_PROGRESS: 'host-in-progress-screen', RESULTS: 'results-screen', PLAYER_LOBBY: 'player-lobby-screen',
            PLAYER_ANSWER: 'player-answer-screen', PLAYER_FINISHED: 'player-finished-screen', HISTORY: 'history-screen', REPORT: 'report-screen',
        },
        GAME_STATUS: { WAITING: 'waiting', IN_PROGRESS: 'in-progress', FINISHED: 'finished' },
        PLAYER_STATUS: { PLAYING: 'playing', COMPLETED: 'completed' }
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const DEFAULT_COVER_IMAGES = [
        'https://images.pexels.com/photos/3408744/pexels-photo-3408744.jpeg',
        'https://images.pexels.com/photos/356079/pexels-photo-356079.jpeg',
        'https://images.pexels.com/photos/3244513/pexels-photo-3244513.jpeg',
        'https://images.pexels.com/photos/2387873/pexels-photo-2387873.jpeg'
    ];
    
    const appState = {
        userId: null, currentQuizId: null, currentQuizForHistory: null, gameSessionId: null,
        playerId: null, gamePin: null, isHost: false, gameUnsubscribe: null, playersUnsubscribe: null,
        exam: { questions: [], currentIndex: 0, score: 0, answers: [] },
        confettiInterval: null, audioUnlocked: false,
    };

    const sfx = { applause: new Audio('sfx-applause.mp3') };
    
    // ✨ NEW: Language Helper Function
    const getTextInLanguage = (data, lang) => {
        if (typeof data === 'object' && data !== null) {
            return data[lang] || data.en || data.th || ''; // Fallback logic
        }
        return typeof data === 'string' ? data : ''; // Backward compatibility
    };

    const screens = document.querySelectorAll('.screen');
    const showAlert = (message) => { document.getElementById('alert-message').textContent = message; document.getElementById('alert-modal').style.display = 'flex'; };
    document.getElementById('alert-ok-btn').addEventListener('click', () => { document.getElementById('alert-modal').style.display = 'none'; });
    
    const navigateTo = (screenId) => {
        if (appState.playersUnsubscribe) { appState.playersUnsubscribe(); appState.playersUnsubscribe = null; }
        screens.forEach(s => s.classList.remove('active'));
        const nextScreen = document.getElementById(screenId);
        if (nextScreen) {
            nextScreen.classList.add('active');
            sessionStorage.setItem('currentScreen', screenId);
        } else {
            document.getElementById(CONSTANTS.SCREENS.HOME).classList.add('active');
            sessionStorage.setItem('currentScreen', CONSTANTS.SCREENS.HOME);
        }
    };

    const clearGameState = () => {
        if (sfx.applause) { sfx.applause.pause(); sfx.applause.currentTime = 0; }
        if (appState.confettiInterval) { clearInterval(appState.confettiInterval); appState.confettiInterval = null; }
        if (appState.gameUnsubscribe) { appState.gameUnsubscribe(); appState.gameUnsubscribe = null; }
        if (appState.playersUnsubscribe) { appState.playersUnsubscribe(); appState.playersUnsubscribe = null; }
        Object.assign(appState, { gameSessionId: null, playerId: null, gamePin: null, isHost: false, exam: { questions: [], currentIndex: 0, score: 0, answers: [] } });
        sessionStorage.clear();
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            appState.userId = user.uid;
            document.getElementById('user-id-display').textContent = user.isAnonymous ? `${user.uid.substring(0, 8)} (Guest)` : (user.displayName || 'Player');
            // No automatic session restore on auth state change. It will be called on DOMContentLoaded.
        } else {
            console.log("No authenticated user found. Redirecting to the main lobby.");
            window.location.href = 'index.html';
        }
    });

    const restoreSession = () => {
        appState.gameSessionId = sessionStorage.getItem('gameSessionId');
        appState.playerId = sessionStorage.getItem('playerId');
        appState.gamePin = sessionStorage.getItem('gamePin');
        appState.isHost = sessionStorage.getItem('isHost') === 'true';
        const savedExam = sessionStorage.getItem('examState');
        if (savedExam) appState.exam = JSON.parse(savedExam);
        const lastScreen = sessionStorage.getItem('currentScreen') || CONSTANTS.SCREENS.HOME;
        if (appState.gameSessionId) {
            if (appState.isHost) rejoinAsHost();
            else if (appState.playerId) { 
                listenToGameSession(appState.gameSessionId);
                navigateTo(lastScreen); 
            }
        } else {
            navigateTo(CONSTANTS.SCREENS.HOME);
        }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        // ✨ NEW: Language selection logic
        const setLanguage = (lang) => {
            localStorage.setItem('examLanguage', lang);
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedBtn = document.getElementById(`lang-${lang}-btn`);
            if(selectedBtn) selectedBtn.classList.add('selected');
        };
        const initialLang = localStorage.getItem('examLanguage') || 'en';
        setLanguage(initialLang);
        document.getElementById('lang-th-btn')?.addEventListener('click', () => setLanguage('th'));
        document.getElementById('lang-en-btn')?.addEventListener('click', () => setLanguage('en'));

        restoreSession(); // Restore session after setting up language listeners.
    });
    
    document.getElementById('show-host-options-btn').addEventListener('click', () => navigateTo(CONSTANTS.SCREENS.HOST_OPTIONS));
    
    document.getElementById('show-player-join-btn').addEventListener('click', () => {
        const user = auth.currentUser;
        const playerNameInput = document.getElementById('player-name-input');
        if (user && !user.isAnonymous && user.displayName) {
            playerNameInput.value = user.displayName;
        } else {
            playerNameInput.value = '';
        }
        navigateTo(CONSTANTS.SCREENS.PLAYER_JOIN);
    });
    
    document.getElementById('back-to-home-from-results-btn').addEventListener('click', () => { clearGameState(); navigateTo(CONSTANTS.SCREENS.HOME); });
    
    document.querySelectorAll('.back-btn').forEach(btn => { 
        btn.addEventListener('click', (e) => { 
            const parentScreen = e.target.closest('.screen').id; 
            if (parentScreen === CONSTANTS.SCREENS.HOST_LOBBY && appState.gameSessionId) {
                if (window.confirm('Are you sure you want to cancel this game?')) {
                    deleteDoc(doc(db, `/artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, appState.gameSessionId));
                    clearGameState();
                } else { return; }
            }
            const screenMap = {
                [CONSTANTS.SCREENS.HOST_OPTIONS]: CONSTANTS.SCREENS.HOME,
                [CONSTANTS.SCREENS.PLAYER_JOIN]: CONSTANTS.SCREENS.HOME,
                [CONSTANTS.SCREENS.QUIZ_CREATOR]: CONSTANTS.SCREENS.HOST_OPTIONS,
                [CONSTANTS.SCREENS.MY_QUIZZES]: CONSTANTS.SCREENS.HOST_OPTIONS
            };
            const targetScreen = screenMap[parentScreen] || CONSTANTS.SCREENS.HOME;
            navigateTo(targetScreen);
        }); 
    });
    
    document.querySelectorAll('.back-to-quizzes-btn, .back-to-history-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const screen = e.target.closest('.screen');
            if (screen.id === CONSTANTS.SCREENS.REPORT) {
                 if (appState.currentQuizForHistory && appState.currentQuizForHistory.id) {
                    viewReports(appState.currentQuizForHistory.id, appState.currentQuizForHistory.title);
                } else {
                    navigateTo(CONSTANTS.SCREENS.MY_QUIZZES);
                }
            } else {
                navigateTo(CONSTANTS.SCREENS.MY_QUIZZES);
            }
        });
    });
    
    document.getElementById('view-my-quizzes-btn').addEventListener('click', async () => {
        navigateTo(CONSTANTS.SCREENS.MY_QUIZZES);
        const listEl = document.getElementById('my-quizzes-list');
        const searchInput = document.getElementById('search-quiz-input');
        searchInput.value = '';
        listEl.innerHTML = '<p>Loading...</p>';
        try {
            const q = query(collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/quizzes`));
            const querySnapshot = await getDocs(q);
            const allQuizzes = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            
            const renderQuizzes = (quizzesToRender) => {
                listEl.innerHTML = '';
                if (quizzesToRender.length === 0) {
                    listEl.innerHTML = `<p class="col-span-full text-center text-gray-500">${searchInput.value ? 'No exams found.' : 'You haven’t created any exams yet.'}</p>`;
                    return;
                }
                const lang = localStorage.getItem('examLanguage') || 'en';
                quizzesToRender.forEach(({ id, data: quiz }) => {
                    const card = document.createElement('div');
                    card.className = 'relative bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col transition-transform hover:scale-105';
                    // --- โค้ดสำหรับดึงค่าต่างๆ (ใช้ ?? เพื่อป้องกัน error) ---
                    const totalPlays = quiz.playCount ?? 0;
                    const rating = quiz.rating ?? 0;

                    card.innerHTML = `
                        <div class="relative">
                            <img class="w-full h-32 object-cover" src="${quiz.coverImageUrl || 'https://images.pexels.com/photos/356079/pexels-photo-356079.jpeg'}" alt="Exam Cover Image">
                            <div class="absolute top-2 right-2 bg-white/80 backdrop-blur-sm px-2 py-1 rounded-full flex items-center gap-1 text-sm font-bold text-yellow-600">
                                <i class="fas fa-star"></i>
                                <span>${rating.toFixed(1)}</span>
                            </div>
                        </div>
                        <div class="p-4 flex-grow flex flex-col">
                            <h3 class="text-lg font-bold mb-2 text-gray-800">${getTextInLanguage(quiz.title, lang)}</h3>
                            <p class="text-gray-600 text-xs mb-3 flex-grow">${getTextInLanguage(quiz.description, lang) || 'No description.'}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500 border-t pt-3 mt-auto">
                                <span class="flex items-center gap-1.5"><i class="fas fa-list-ol"></i>${quiz.questions.length} Questions</span>
                                <span class="flex items-center gap-1.5"><i class="fas fa-users"></i>${totalPlays} Plays</span>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 grid grid-cols-1">
                             <button class="start-session-btn w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition-colors">Start Exam</button>
                        </div>
                        <div class="absolute top-2 left-2 flex gap-1">
                             <button class="edit-quiz-btn text-xs bg-yellow-500 text-white px-2 py-1 rounded-md hover:bg-yellow-600">Edit</button>
                             <button class="delete-quiz-btn text-xs bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600">Delete</button>
                             <button class="reports-quiz-btn text-xs bg-cyan-500 text-white px-2 py-1 rounded-md hover:bg-cyan-600">Reports</button>
                        </div>
                    `;
                    card.querySelector('.start-session-btn').addEventListener('click', () => hostGame(id));
                    card.querySelector('.edit-quiz-btn').addEventListener('click', () => editQuiz(id));
                    card.querySelector('.delete-quiz-btn').addEventListener('click', () => deleteQuiz(id));
                    card.querySelector('.reports-quiz-btn').addEventListener('click', () => viewReports(id, quiz.title));
                    listEl.appendChild(card);
                });
            };
            renderQuizzes(allQuizzes);
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const lang = localStorage.getItem('examLanguage') || 'en';
                const filteredQuizzes = allQuizzes.filter(quiz => 
                    getTextInLanguage(quiz.data.title, lang).toLowerCase().includes(searchTerm)
                );
                renderQuizzes(filteredQuizzes);
            });
        } catch (error) {
            console.error("Error loading quizzes:", error);
            listEl.innerHTML = '<p class="text-red-500 col-span-full">Failed to load exams.</p>';
        }
    });

    const editQuiz = async (quizId) => { 
        try { 
            const quizDoc = await getDoc(doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/quizzes`, quizId)); 
            if (!quizDoc.exists()) return showAlert('Exam not found'); 
            const quiz = quizDoc.data(); 
            resetQuizCreator(); 
            appState.currentQuizId = quizId; 
            document.getElementById('quiz-title-th').value = getTextInLanguage(quiz.title, 'th');
            document.getElementById('quiz-title-en').value = getTextInLanguage(quiz.title, 'en');
            document.getElementById('quiz-description-th').value = getTextInLanguage(quiz.description, 'th');
            document.getElementById('quiz-description-en').value = getTextInLanguage(quiz.description, 'en');
            document.getElementById('questions-container').innerHTML = ''; 
            quiz.questions.forEach(q => addQuestionToForm(q)); 
            navigateTo(CONSTANTS.SCREENS.QUIZ_CREATOR); 
        } catch (error) { console.error("Error fetching quiz for edit:", error); showAlert('An error occurred'); } 
    };

    const deleteQuiz = async (quizId) => { if (window.confirm('Are you sure you want to delete this exam?')) { try { await deleteDoc(doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/quizzes`, quizId)); showAlert('Exam deleted.'); document.getElementById('view-my-quizzes-btn').click(); } catch (error) { console.error("Error deleting quiz:", error); showAlert('Failed to delete exam.'); } } };
    const shareReportByEmail = (report) => {
        const recipientEmail = prompt("Please enter recipient email (use commas to separate multiple emails):");
        if (recipientEmail) {
            const lang = localStorage.getItem('examLanguage') || 'en';
            const subject = `Exam Results: ${getTextInLanguage(report.quizTitle, lang)} (${report.sessionName})`;

            let body = `Exam Results Summary:\n\n`;
            body += `Title: ${getTextInLanguage(report.quizTitle, lang)}\n`;
            body += `Session: ${report.sessionName}\n`;
            body += `------------------------------------\n`;
            body += `Summary:\n`;
            body += `- Participants: ${report.summary.participantsCount} \n`;
            body += `- Overall Accuracy: ${report.summary.accuracy}%\n`;
            body += `- Questions: ${report.summary.questionsCount}\n\n`;
            body += `Leaderboard:\n`;
            report.participants.slice(0, 10).forEach((p, index) => {
                body += `${index + 1}. ${p.name} - ${p.score} Score (Accuracy: ${p.accuracy}%)\n`;
            });
            if (report.participants.length > 10) {
                body += `...\n`;
            }
            body += `\n------------------------------------\n`;
            body += `Question Breakdown:\n\n`;
            report.questions.forEach((q, index) => {
                body += `${index + 1}. ${getTextInLanguage(q.text, lang)} (Accuracy: ${q.accuracy}%)\n`;
                q.options.forEach((opt, i) => {
                    const isCorrect = i === q.correctIndex ? ' ✔️ ' : '    ';
                    body += `${isCorrect}${getTextInLanguage(opt.text, lang)} (${opt.answerCount} answers)\n`;
                });
                body += `\n`;
            });
            body += `\nReport generated by TRC Exam System.`;

            try {
                navigator.clipboard.writeText(body);
                showAlert('Report content copied to clipboard! You can now paste it into your email.');
                const encodedSubject = encodeURIComponent(subject);
                const mailtoLink = `mailto:${recipientEmail}?subject=${encodedSubject}`;
                window.open(mailtoLink, '_blank');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showAlert('Could not copy content automatically.');
            }
        }
    };
    
    // ✨ MODIFIED: hostGame with sessionName
    const hostGame = async (quizId) => { 
        let pin; let isPinUnique = false; let attempts = 0; 
        while (!isPinUnique && attempts < 10) { 
            pin = Math.floor(1000 + Math.random() * 9000).toString(); 
            const q = query(collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`), where("pin", "==", pin), where("status", "in", [CONSTANTS.GAME_STATUS.WAITING, CONSTANTS.GAME_STATUS.IN_PROGRESS])); 
            const querySnapshot = await getDocs(q); 
            if (querySnapshot.empty) isPinUnique = true; 
            attempts++; 
        } 
        if (!isPinUnique) return showAlert('Could not generate a unique game pin. Please try again.'); 
        try { 
            const sessionName = document.getElementById('session-name-input')?.value.trim() || `Exam Session @ ${new Date().toLocaleDateString()}`;
            const gameSessionRef = await addDoc(collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`), { quizId: quizId, hostId: appState.userId, pin: pin, sessionName: sessionName, status: CONSTANTS.GAME_STATUS.WAITING, createdAt: serverTimestamp() }); 
            appState.gameSessionId = gameSessionRef.id; 
            appState.gamePin = pin; appState.isHost = true; 
            sessionStorage.setItem('gameSessionId', appState.gameSessionId); 
            sessionStorage.setItem('gamePin', appState.gamePin); 
            sessionStorage.setItem('isHost', 'true'); 
            listenToGameSession(appState.gameSessionId); 
            navigateTo(CONSTANTS.SCREENS.HOST_LOBBY); 
            document.getElementById('game-pin-display').textContent = pin; 
            document.getElementById('session-name-input').value = '';
            listenToPlayersInLobby(appState.gameSessionId); 
        } catch (error) { showAlert('Failed to create game room.'); } 
    };

    const listenToPlayersInLobby = (sessionId) => { const playersRef = collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, sessionId, 'players'); appState.playersUnsubscribe = onSnapshot(playersRef, (snapshot) => { const playerList = document.getElementById('player-list'); if (!playerList) return; playerList.innerHTML = ''; snapshot.docs.forEach(doc => { const playerEl = document.createElement('div'); playerEl.className = 'bg-gray-200 p-2 rounded-md'; playerEl.textContent = doc.data().name; playerList.appendChild(playerEl); }); document.getElementById('player-count').textContent = snapshot.size; document.getElementById('start-game-btn').disabled = snapshot.size === 0; }); };
    document.getElementById('start-game-btn').addEventListener('click', async () => { 
        const sessionName = document.getElementById('session-name-input')?.value.trim();
        if (appState.gameSessionId) {
            await updateDoc(doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, appState.gameSessionId), { 
                status: CONSTANTS.GAME_STATUS.IN_PROGRESS,
                sessionName: sessionName || `Exam Session @ ${new Date().toLocaleDateString()}`
            }); 
        }
    });

    const listenToPlayerProgress = (sessionId) => { const playersRef = collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, sessionId, 'players'); appState.playersUnsubscribe = onSnapshot(playersRef, (snapshot) => { const playerList = document.getElementById('in-progress-player-list'); if (!playerList) return; playerList.innerHTML = ''; let completedCount = 0; snapshot.docs.forEach(doc => { const player = doc.data(); const playerEl = document.createElement('div'); const isCompleted = player.status === CONSTANTS.PLAYER_STATUS.COMPLETED; if(isCompleted) completedCount++; playerEl.className = `p-2 rounded-md transition-all ${isCompleted ? 'bg-emerald-200 text-emerald-800' : 'bg-gray-200'}`; playerEl.innerHTML = `<i class="fas ${isCompleted ? 'fa-check-circle' : 'fa-spinner fa-spin'} mr-2"></i>${player.name}`; playerList.appendChild(playerEl); }); document.getElementById('completed-players-count').textContent = completedCount; document.getElementById('total-players-count').textContent = snapshot.size; const allPlayersCompleted = snapshot.size > 0 && completedCount === snapshot.size; document.getElementById('end-game-btn').disabled = !allPlayersCompleted; }); };
    document.getElementById('join-game-btn').addEventListener('click', async (event) => { const btn = event.target; btn.disabled = true; btn.textContent = 'Joining...'; const pin = document.getElementById('game-pin-input').value.trim(); const name = document.getElementById('player-name-input').value.trim(); if (!pin || !name) { btn.disabled = false; btn.textContent = 'Join'; return showAlert('Please enter pin and name.'); } try { const q = query(collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`), where("pin", "==", pin), where("status", "==", CONSTANTS.GAME_STATUS.WAITING)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { btn.disabled = false; btn.textContent = 'Join'; return showAlert('Game not found.'); } const gameDoc = querySnapshot.docs[0]; appState.gameSessionId = gameDoc.id; const playerRef = await addDoc(collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, appState.gameSessionId, 'players'), { name: name, score: 0, answers: [], status: CONSTANTS.PLAYER_STATUS.PLAYING }); appState.playerId = playerRef.id; appState.isHost = false; sessionStorage.setItem('gameSessionId', appState.gameSessionId); sessionStorage.setItem('playerId', appState.playerId); sessionStorage.setItem('isHost', 'false'); listenToGameSession(appState.gameSessionId); navigateTo(CONSTANTS.SCREENS.PLAYER_LOBBY); } catch (error) { showAlert('Error joining game.'); btn.disabled = false; btn.textContent = 'Join'; } });
    const startSelfPacedQuiz = async (game) => {
        if (appState.exam.questions.length > 0) return;
        try {
            const quizDoc = await getDoc(doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/quizzes`, game.quizId));
            if (!quizDoc.exists()) throw new Error("Question set not found.");

            // ✨ EDIT: เพิ่ม originalIndex เข้าไปในแต่ละคำถามก่อนทำการ shuffle
            const originalQuestions = quizDoc.data().questions.map((q, index) => ({
                ...q,
                originalIndex: index 
            }));
            appState.exam.questions = originalQuestions.sort(() => Math.random() - 0.5);

            appState.exam.currentIndex = 0;
            appState.exam.score = 0;
            appState.exam.answers = [];
            navigateTo(CONSTANTS.SCREENS.PLAYER_ANSWER);
            renderExamQuestion();
        } catch (error) {
            showAlert(error.message);
        }
    };
    
    // ✨ MODIFIED: renderExamQuestion with language support
    const renderExamQuestion = () => { 
        sessionStorage.setItem('examState', JSON.stringify(appState.exam)); 
        const question = appState.exam.questions[appState.exam.currentIndex]; 
        if (!question) return finishExam(); 
        const lang = localStorage.getItem('examLanguage') || 'en';
        document.getElementById('exam-progress').textContent = `Question ${appState.exam.currentIndex + 1} / ${appState.exam.questions.length}`; 
        document.getElementById('player-q-text').textContent = getTextInLanguage(question.text, lang); 
        const optionsContainer = document.getElementById('exam-options-container'); 
        optionsContainer.innerHTML = ''; 
        question.options.forEach((option, index) => { 
            const optionId = `q${appState.exam.currentIndex}-opt${index}`; 
            const optionDiv = document.createElement('div'); 
            optionDiv.innerHTML = `<input type="radio" id="${optionId}" name="exam-answer" value="${index}" class="hidden peer"><label for="${optionId}" class="block w-full p-4 rounded-lg border-2 border-gray-200 cursor-pointer peer-checked:border-indigo-600 peer-checked:bg-indigo-50"><span class="font-semibold text-gray-700">${getTextInLanguage(option, lang)}</span></label>`; 
            optionsContainer.appendChild(optionDiv); 
        }); 
    };

    document.getElementById('exam-submit-btn').addEventListener('click', () => {
        const selectedOption = document.querySelector('input[name="exam-answer"]:checked');
        if (!selectedOption) return showAlert("Please select an answer.");
        const question = appState.exam.questions[appState.exam.currentIndex];
        const selectedIndex = parseInt(selectedOption.value);
        if (selectedIndex === question.correctIndex) appState.exam.score++;

        // ✨ EDIT: เปลี่ยนจากการบันทึก questionText มาเป็น originalIndex แทน
        appState.exam.answers.push({
            originalIndex: question.originalIndex,
            selectedIndex: selectedIndex,
            isCorrect: selectedIndex === question.correctIndex
        });

        appState.exam.currentIndex++;
        renderExamQuestion();
    });
    const finishExam = () => { navigateTo(CONSTANTS.SCREENS.PLAYER_FINISHED); submitFinalResults(); };
    const submitFinalResults = async () => { if (!appState.playerId || !appState.gameSessionId) return; try { const playerRef = doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, appState.gameSessionId, 'players', appState.playerId); await updateDoc(playerRef, { score: appState.exam.score, answers: appState.exam.answers, status: CONSTANTS.PLAYER_STATUS.COMPLETED }); sessionStorage.removeItem('examState'); } catch (error) { showAlert("Error submitting exam."); } };
    const displayResultsWithPodium = async (sessionId) => { if(sfx.applause) sfx.applause.play().catch(e => console.warn(e)); const playersRef = collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, sessionId, 'players'); const snapshot = await getDocs(playersRef); const players = snapshot.docs.map(doc => ({ name: doc.data().name, score: doc.data().score || 0 })); players.sort((a, b) => b.score - a.score); const podiumEl = document.getElementById('final-podium'); const listEl = document.getElementById('leaderboard-list'); podiumEl.innerHTML = ''; listEl.innerHTML = ''; const top3 = players.slice(0, 3); const rest = players.slice(3); const podiumOrder = [1, 0, 2]; podiumOrder.forEach(rankIndex => { const player = top3[rankIndex]; if (!player) return; const rank = rankIndex + 1; const podiumDiv = document.createElement('div'); podiumDiv.className = `podium-item podium-${rank}`; podiumDiv.innerHTML = ` ${rank === 1 ? '<i class="fas fa-crown"></i>' : ''} <div class="podium-rank">${rank}</div> <div class="podium-name">${player.name}</div> <div class="podium-score">${player.score} Score</div> `; podiumEl.appendChild(podiumDiv); }); rest.forEach((player, i) => { const rank = i + 4; const itemEl = document.createElement('div'); itemEl.className = 'flex justify-between items-center p-3 rounded-lg bg-gray-100'; itemEl.innerHTML = `<div class="flex items-center gap-3"><span class="font-bold w-8 text-center text-lg">${rank}</span><span>${player.name}</span></div><span class="font-bold text-indigo-600">${player.score} Score</span>`; listEl.appendChild(itemEl); }); setTimeout(() => { document.querySelectorAll('.podium-item').forEach(el => el.classList.add('animate')); var duration = 5 * 1000; var animationEnd = Date.now() + duration; var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 }; function randomInRange(min, max) { return Math.random() * (max - min) + min; } appState.confettiInterval = setInterval(function() { var timeLeft = animationEnd - Date.now(); if (timeLeft <= 0) { return clearInterval(appState.confettiInterval); } var particleCount = 50 * (timeLeft / duration); confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }); confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }); }, 250); }, 100); };
    const generateReport = async (sessionId, quizId, sessionName) => {
        const reportRef = doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameReports`, sessionId);
        if ((await getDoc(reportRef)).exists()) return;

        const quizDoc = await getDoc(doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/quizzes`, quizId));
        if (!quizDoc.exists()) return;
        const quiz = quizDoc.data();

        const playersSnapshot = await getDocs(collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, sessionId, 'players'));
        const playersData = playersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

        let totalCorrect = 0;
        let totalAttempted = 0;

        const participantsReport = playersData.map(player => {
            let correctCount = 0;

            const answersReport = quiz.questions.map((q, i) => {
                // ✨ EDIT: แก้ไขการจับคู่จุดที่ 1
                const answerData = player.answers.find(a => a.originalIndex === i);

                if (answerData) {
                    if (answerData.isCorrect) {
                        correctCount++;
                    }
                    return { isCorrect: answerData.isCorrect };
                }
                return { isCorrect: null };
            });

            totalAttempted += player.answers.length;
            totalCorrect += correctCount;

            return {
                name: player.name,
                score: player.score || 0,
                accuracy: quiz.questions.length > 0 ? Math.round((correctCount / quiz.questions.length) * 100) : 0,
                correctCount,
                totalQuestions: quiz.questions.length,
                answers: answersReport
            };
        });

        const questionsReport = quiz.questions.map((q, i) => {
            const optionCounts = Array(q.options.length).fill(0);
            let correctAnswers = 0;
            playersData.forEach(p => {
                // ✨ EDIT: แก้ไขการจับคู่จุดที่ 2
                const answerData = p.answers.find(a => a.originalIndex === i);

                if (answerData) {
                    optionCounts[answerData.selectedIndex]++;
                    if (answerData.isCorrect) correctAnswers++;
                }
            });
            const totalAnswersForQ = optionCounts.reduce((a, b) => a + b, 0);
            return {
                text: q.text,
                accuracy: totalAnswersForQ > 0 ? Math.round((correctAnswers / totalAnswersForQ) * 100) : 0,
                options: q.options.map((opt, optIdx) => ({ text: opt, answerCount: optionCounts[optIdx] })),
                correctIndex: q.correctIndex
            };
        });

        const finalReport = {
            quizId,
            quizTitle: quiz.title,
            sessionName,
            playedAt: serverTimestamp(),
            summary: {
                accuracy: totalAttempted > 0 ? Math.round((totalCorrect / totalAttempted) * 100) : 0,
                completion: playersData.length > 0 && quiz.questions.length > 0 ? Math.round((totalAttempted / (quiz.questions.length * playersData.length)) * 100) : 0,
                participantsCount: playersData.length,
                questionsCount: quiz.questions.length
            },
            participants: participantsReport.sort((a, b) => b.score - a.score),
            questions: questionsReport
        };
        await setDoc(reportRef, finalReport);

        const quizDocRef = doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/quizzes`, quizId);
        await updateDoc(quizDocRef, {
            playCount: increment(playersData.length)
        });
    };
    const viewReports = async (quizId, quizTitle) => { appState.currentQuizForHistory = { id: quizId, title: quizTitle }; navigateTo(CONSTANTS.SCREENS.HISTORY); const lang = localStorage.getItem('examLanguage') || 'en'; document.getElementById('history-quiz-title').textContent = getTextInLanguage(quizTitle, lang); const listEl = document.getElementById('history-list'); listEl.innerHTML = '<p>Loading...</p>'; try { const q = query(collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameReports`), where("quizId", "==", quizId), orderBy("playedAt", "desc")); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { listEl.innerHTML = '<p>No reports for this exam.</p>'; return; } listEl.innerHTML = ''; querySnapshot.forEach(doc => { const report = doc.data(); const d = report.playedAt.toDate(); const dateString = `${d.toLocaleDateString()} ${d.toLocaleTimeString()}`; const itemEl = document.createElement('div'); itemEl.className = 'bg-gray-100 p-3 rounded-lg flex justify-between items-center'; itemEl.innerHTML = `<div class="flex-grow cursor-pointer hover:bg-gray-200 -m-3 p-3 rounded-lg report-clickable-area"><p class="font-bold">${report.sessionName}</p><p class="text-sm text-gray-500">${dateString} - ${report.summary.participantsCount} Participants</p></div><button data-id="${doc.id}" class="delete-report-btn ml-4 bg-red-500 text-white font-bold py-1 px-2 rounded-md text-xs hover:bg-red-600"><i class="fas fa-trash"></i></button>`; itemEl.querySelector('.report-clickable-area').addEventListener('click', () => renderReportScreen(report)); itemEl.querySelector('.delete-report-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteReport(e.target.closest('button').dataset.id); }); listEl.appendChild(itemEl); }); } catch (error) { console.error(error); listEl.innerHTML = '<p class="text-red-500">Error loading history.</p>'; } };
    const deleteReport = async (reportId) => { if (window.confirm('Delete this report permanently?')) { try { await deleteDoc(doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameReports`, reportId)); showAlert('Report deleted.'); if(appState.currentQuizForHistory) { viewReports(appState.currentQuizForHistory.id, appState.currentQuizForHistory.title); } } catch (error) { showAlert('Failed to delete report.'); } } };
    // FUNCTION 1: แสดงผลหน้ารายงาน (แทนที่ของเดิม)
    const renderReportScreen = (report) => {
        navigateTo(CONSTANTS.SCREENS.REPORT);
        const lang = localStorage.getItem('examLanguage') || 'en';

        // --- เติมข้อมูลสรุปด้านบน ---
        document.getElementById('report-quiz-title').textContent = getTextInLanguage(report.quizTitle, lang);
        document.getElementById('report-session-name').textContent = report.sessionName;
        document.getElementById('report-summary-accuracy').textContent = `${report.summary.accuracy}%`;
        document.getElementById('report-summary-completion').textContent = `${report.summary.completion}%`;
        document.getElementById('report-summary-participants').textContent = report.summary.participantsCount;
        document.getElementById('report-summary-questions').textContent = report.summary.questionsCount;

        // --- สร้างปุ่ม Share ---
        const shareButton = document.getElementById('share-report-btn');
        if (shareButton) {
            const newShareButton = shareButton.cloneNode(true);
            shareButton.parentNode.replaceChild(newShareButton, shareButton);
            newShareButton.addEventListener('click', () => shareReportByEmail(report)); // หากต้องการฟังก์ชัน share ให้เอา comment ออก
        }

        // --- เรียกใช้ฟังก์ชันเพื่อแสดงผลในแต่ละแท็บ ---
        renderParticipants(report.participants);
        renderQuestions(report.questions);

        // --- โค้ดสำหรับสลับแท็บ ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                tabContents.forEach(c => c.classList.add('hidden'));
                const contentId = btn.id.replace('btn', 'content');
                document.getElementById(contentId).classList.remove('hidden');
            });
        });

        // --- ตั้งค่าให้แท็บ Participants แสดงเป็นค่าเริ่มต้น ---
        document.getElementById('tab-btn-participants').classList.add('active');
        document.getElementById('tab-content-participants').classList.remove('hidden');
        document.getElementById('tab-content-questions').classList.add('hidden');
    };
    // FUNCTION 2: แสดงผลรายชื่อผู้เข้าร่วม (เพิ่มเข้าไปใหม่)
    const renderParticipants = (participants) => {
        const container = document.getElementById('tab-content-participants');
        container.innerHTML = '<div class="space-y-4"></div>';
        const listEl = container.querySelector('.space-y-4');

        if (!participants || participants.length === 0) {
            listEl.innerHTML = '<p>No participant data available.</p>';
            return;
        }

        participants.forEach(p => {
            let progressBar = ''; // กำหนดค่าเริ่มต้นเป็น progress bar ว่างๆ

            // ✨ จุดที่แก้ไข: เพิ่มการตรวจสอบ p.answers ตรงนี้
            // ถ้ามี p.answers และเป็น Array ถึงจะสร้าง progress bar แบบมีสี
            if (p.answers && Array.isArray(p.answers)) {
                progressBar = p.answers.map(ans => {
                    if (ans.isCorrect === null) {
                        return `<div class="flex-1 h-2 bg-gray-300 rounded"></div>`; // ไม่ได้ตอบ
                    }
                    return `<div class="flex-1 h-2 ${ans.isCorrect ? 'bg-green-500' : 'bg-red-500'} rounded"></div>`;
                }).join('');
            }

            const itemEl = document.createElement('div');
            itemEl.className = 'bg-gray-50 p-4 rounded-lg';
            itemEl.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <p class="font-bold">${p.name}</p>
                    <div class="text-right">
                        <p class="font-semibold text-lg">${p.score || 0} <span class="text-sm font-normal text-gray-600">Score</span></p>
                        <p class="text-sm text-gray-600">${p.accuracy || 0}% (${p.correctCount || 0}/${p.totalQuestions || 0})</p>
                    </div>
                </div>
                <div class="flex gap-1">${progressBar}</div>
            `;
            listEl.appendChild(itemEl);
        });
    };

    // FUNCTION 3: แสดงผลรายละเอียดคำถาม (เพิ่มเข้าไปใหม่)
    const renderQuestions = (questions) => {
        const container = document.getElementById('tab-content-questions');
        container.innerHTML = '<div class="space-y-4"></div>';
        const listEl = container.querySelector('.space-y-4');

        if (!questions || questions.length === 0) {
            listEl.innerHTML = '<p>No question data available.</p>';
            return;
        }

        const lang = localStorage.getItem('examLanguage') || 'en';

        questions.forEach((q, index) => {
            const totalAnswersForQ = q.options.reduce((sum, opt) => sum + opt.answerCount, 0);
            const correctAnswers = q.options[q.correctIndex] ? q.options[q.correctIndex].answerCount : 0;

            const optionsHtml = q.options.map((opt, i) => `
                <div class="flex items-center justify-between py-1">
                    <div class="flex items-center">
                        <span class="font-mono mr-2 text-gray-500">${String.fromCharCode(65 + i)}</span>
                        <p class="${i === q.correctIndex ? 'text-green-600 font-semibold' : ''}">${getTextInLanguage(opt.text, lang)}</p>
                        ${i === q.correctIndex ? '<i class="fas fa-check text-green-500 ml-2"></i>' : ''}
                    </div>
                    <p class="text-sm text-gray-600">${opt.answerCount} Answer(s)</p>
                </div>
            `).join('');

            const totalParticipants = totalAnswersForQ + (q.stats ? q.stats.unattempted : 0);
            const correctWidth = totalParticipants > 0 ? (correctAnswers / totalParticipants) * 100 : 0;
            const incorrectWidth = totalParticipants > 0 ? ((totalAnswersForQ - correctAnswers) / totalParticipants) * 100 : 0;

            const itemEl = document.createElement('div');
            itemEl.className = 'bg-gray-50 p-4 rounded-lg';
            itemEl.innerHTML = `
                <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
                    <span>Multiple Choice</span>
                    <span><i class="fas fa-check-circle text-green-500 mr-1"></i> ${q.accuracy}% Accuracy</span>
                </div>
                <p class="font-semibold mb-3">${index + 1}. ${getTextInLanguage(q.text, lang)}</p>
                <div class="text-sm mb-4">${optionsHtml}</div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 flex">
                    <div class="bg-green-500 h-2.5 rounded-l-full" style="width: ${correctWidth}%"></div>
                    <div class="bg-red-500 h-2.5" style="width: ${incorrectWidth}%"></div>
                </div>
            `;
            listEl.appendChild(itemEl);
        });
    };
    const listenToGameSession = (sessionId) => { if (appState.gameUnsubscribe) appState.gameUnsubscribe(); const gameRef = doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, sessionId); appState.gameUnsubscribe = onSnapshot(gameRef, (docSnap) => { if (!docSnap.exists()) { showAlert("Session ended by host."); clearGameState(); navigateTo(CONSTANTS.SCREENS.HOME); return; } const game = docSnap.data(); const currentScreen = sessionStorage.getItem('currentScreen'); if (appState.isHost) { if (game.status === CONSTANTS.GAME_STATUS.IN_PROGRESS && currentScreen === CONSTANTS.SCREENS.HOST_LOBBY) { navigateTo(CONSTANTS.SCREENS.HOST_IN_PROGRESS); document.getElementById('in-progress-pin').textContent = game.pin; listenToPlayerProgress(sessionId); } } else { if (game.status === CONSTANTS.GAME_STATUS.IN_PROGRESS && currentScreen === CONSTANTS.SCREENS.PLAYER_LOBBY) { startSelfPacedQuiz(game); } else if (game.status === CONSTANTS.GAME_STATUS.FINISHED && (currentScreen === CONSTANTS.SCREENS.PLAYER_FINISHED || currentScreen === CONSTANTS.SCREENS.PLAYER_ANSWER)) { navigateTo(CONSTANTS.SCREENS.RESULTS); displayResultsWithPodium(sessionId); } } }); };
    document.getElementById('end-game-btn').addEventListener('click', async () => {
        if (appState.gameSessionId) {
            try {
                const gameDocRef = doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, appState.gameSessionId);
                const gameDoc = await getDoc(gameDocRef);

                if (gameDoc.exists()) {
                    const gameData = gameDoc.data();
                    // ตรวจสอบให้แน่ใจว่าเรามีข้อมูลที่จำเป็นครบถ้วน
                    if (gameData.quizId && gameData.sessionName) {
                        await generateReport(appState.gameSessionId, gameData.quizId, gameData.sessionName);
                    } else {
                        console.error("Missing quizId or sessionName in game session data.");
                    }
                }

                // ดำเนินการส่วนที่เหลือต่อ
                await updateDoc(gameDocRef, { status: CONSTANTS.GAME_STATUS.FINISHED });
                navigateTo(CONSTANTS.SCREENS.RESULTS);
                displayResultsWithPodium(appState.gameSessionId);

            } catch (error) {
                console.error("Error ending game:", error);
                showAlert("An error occurred while trying to end the game.");
            }
        }
    });
    const rejoinAsHost = async () => { if (!appState.gameSessionId) return; const gameRef = doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/gameSessions`, appState.gameSessionId); const docSnap = await getDoc(gameRef); if (docSnap.exists()) { const game = docSnap.data(); appState.gamePin = game.pin; listenToGameSession(appState.gameSessionId); if (game.status === CONSTANTS.GAME_STATUS.WAITING) { navigateTo(CONSTANTS.SCREENS.HOST_LOBBY); document.getElementById('game-pin-display').textContent = game.pin; listenToPlayersInLobby(appState.gameSessionId); } else if (game.status === CONSTANTS.GAME_STATUS.IN_PROGRESS) { navigateTo(CONSTANTS.SCREENS.HOST_IN_PROGRESS); document.getElementById('in-progress-pin').textContent = game.pin; listenToPlayerProgress(appState.gameSessionId); } else if (game.status === CONSTANTS.GAME_STATUS.FINISHED) { navigateTo(CONSTANTS.SCREENS.RESULTS); displayResultsWithPodium(appState.gameSessionId); } } else { showAlert('Game session not found.'); clearGameState(); navigateTo(CONSTANTS.SCREENS.HOME); } };
    document.getElementById('create-quiz-btn').addEventListener('click', () => { resetQuizCreator(); navigateTo(CONSTANTS.SCREENS.QUIZ_CREATOR); });
    document.getElementById('add-question-btn').addEventListener('click', () => addQuestionToForm());

    // ✨ MODIFIED: resetQuizCreator for bilingual fields
    const resetQuizCreator = () => {
        document.getElementById('quiz-title-th').value = ''; document.getElementById('quiz-title-en').value = '';
        document.getElementById('quiz-description-th').value = ''; document.getElementById('quiz-description-en').value = '';
        document.getElementById('questions-container').innerHTML = ''; 
        appState.currentQuizId = null; 
        addQuestionToForm(); 
    };

    // ✨ MODIFIED: addQuestionToForm for bilingual fields
    const addQuestionToForm = (question = { text: {th:'', en:''}, options: [{}, {}, {}, {}], correctIndex: 0 }) => {
        const container = document.getElementById('questions-container');
        const qIndex = container.children.length;
        const questionDiv = document.createElement('div');
        questionDiv.className = 'bg-gray-50 p-4 rounded-lg mb-4 border';
        questionDiv.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <label class="font-bold">Question ${qIndex + 1}</label>
                <button class="remove-question-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
            </div>
            <div class="grid grid-cols-2 gap-x-4">
                <textarea class="question-text-th w-full p-2 border rounded-md" placeholder="คำถาม (TH)">${getTextInLanguage(question.text, 'th')}</textarea>
                <textarea class="question-text-en w-full p-2 border rounded-md" placeholder="Question (EN)">${getTextInLanguage(question.text, 'en')}</textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                ${[0,1,2,3].map(i => {
                    const opt = question.options[i] || {th:'', en:''};
                    return `
                    <div class="flex items-center bg-white p-2 rounded-md border">
                        <input type="radio" name="correct-answer-${qIndex}" value="${i}" class="correct-answer-radio mr-3 h-5 w-5" ${i === question.correctIndex ? 'checked' : ''}>
                        <div class="w-full">
                            <input type="text" class="option-input-th w-full p-2 border-gray-200 rounded-md mb-1 text-sm" placeholder="ตัวเลือก ${i + 1} (TH)" value="${getTextInLanguage(opt, 'th')}">
                            <input type="text" class="option-input-en w-full p-2 border-gray-200 rounded-md text-sm" placeholder="Option ${i + 1} (EN)" value="${getTextInLanguage(opt, 'en')}">
                        </div>
                    </div>`
                }).join('')}
            </div>
        `;
        container.appendChild(questionDiv);
        questionDiv.querySelector('.remove-question-btn').addEventListener('click', (e) => {
            e.target.closest('.bg-gray-50').remove();
            container.querySelectorAll('.bg-gray-50').forEach((div, index) => {
                div.querySelector('label').textContent = `Question ${index + 1}`;
            });
        });
    };

    // ✨ MODIFIED: save-quiz-btn listener for bilingual data
    document.getElementById('save-quiz-btn').addEventListener('click', async () => { 
        const btn = document.getElementById('save-quiz-btn'); 
        btn.disabled = true; btn.textContent = "Saving..."; 
        if (!appState.userId) { btn.disabled = false; btn.textContent = "Save"; return showAlert('User not authenticated.'); } 
        const title_th = document.getElementById('quiz-title-th').value.trim();
        const title_en = document.getElementById('quiz-title-en').value.trim();
        const description_th = document.getElementById('quiz-description-th').value.trim();
        const description_en = document.getElementById('quiz-description-en').value.trim();
        if (!title_en && !title_th) { btn.disabled = false; btn.textContent = "Save"; return showAlert('Please enter an exam title in at least one language.'); } 
        
        const questions = Array.from(document.querySelectorAll('#questions-container > div')).map(el => {
            const text_th = el.querySelector('.question-text-th').value.trim();
            const text_en = el.querySelector('.question-text-en').value.trim();
            const options_th = Array.from(el.querySelectorAll('.option-input-th')).map(input => input.value.trim());
            const options_en = Array.from(el.querySelectorAll('.option-input-en')).map(input => input.value.trim());
            const options = options_th.map((th, i) => ({ th: th, en: options_en[i] }));
            const correctIndex = parseInt(el.querySelector('.correct-answer-radio:checked')?.value);
            return { text: { th: text_th, en: text_en }, options, correctIndex };
        });

        if (questions.some(q => (!q.text.th && !q.text.en) || q.options.some(opt => (!opt.th && !opt.en)) || isNaN(q.correctIndex))) { 
            btn.disabled = false; btn.textContent = "Save"; return showAlert('Please complete all questions and options in at least one language, and select a correct answer.'); 
        } 
        if (questions.length === 0) { btn.disabled = false; btn.textContent = "Save"; return showAlert('Please add at least one question.'); } 
        
    const quizData = {
        title: { th: title_th, en: title_en },
        description: { th: description_th, en: description_en },
        questions,
        creatorId: appState.userId,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(), //  <-- ✨ เพิ่ม comma ตรงนี้
        // --- เพิ่ม 3 บรรทัดนี้เข้าไป ---
        coverImageUrl: DEFAULT_COVER_IMAGES[Math.floor(Math.random() * DEFAULT_COVER_IMAGES.length)],
        playCount: 0,
        rating: 0
    };

        try { 
            if (appState.currentQuizId) { 
                await setDoc(doc(db, `artifacts/${CONSTANTS.APP_ID}/public/data/quizzes`, appState.currentQuizId), { ...quizData, updatedAt: serverTimestamp() }, { merge: true }); 
                showAlert('Exam updated successfully!'); 
            } else { 
                await addDoc(collection(db, `artifacts/${CONSTANTS.APP_ID}/public/data/quizzes`), quizData); 
                showAlert('Exam created successfully!'); 
            } 
            document.getElementById('view-my-quizzes-btn').click(); 
        } catch (error) { console.error("Error saving quiz:", error); showAlert('Error saving exam.'); } 
        finally { btn.disabled = false; btn.textContent = "Save"; } 
    });
</script>
</body>
</html>